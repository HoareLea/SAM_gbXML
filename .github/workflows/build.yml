name: Build (Windows)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    # Guard: if this workflow is ever merged upstream (e.g. HoareLea),
    # it will show as "skipped" and won't break their CI/branch protections.
    if: github.repository_owner == 'SAM-BIM'
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Clone deps + build
        shell: pwsh
        env:
          MSBUILDDISABLENODEREUSE: "1"
        run: |
          $ErrorActionPreference = 'Stop'

          # -----------------------------
          # CONFIG: deps for this repo
          # -----------------------------
          $branch = 'master'
          $deps = @(
            @{ name = 'SAM'; url = 'https://github.com/SAM-BIM/SAM.git' }
          )

          # Repo name from GITHUB_REPOSITORY (e.g. SAM-BIM/SAM_gbXML -> SAM_gbXML)
          $repo = ($env:GITHUB_REPOSITORY -split '/')[1]

          # -----------------------------
          # IMPORTANT: cache OUTSIDE repo
          # avoids robocopy recursion/hangs
          # -----------------------------
          $cache = Join-Path $env:RUNNER_TEMP 'gitcache'

          if (Test-Path $cache) { Remove-Item $cache -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $cache | Out-Null

          function Clone-Repo([string]$name, [string]$url) {
            $dst = Join-Path $cache $name
            Write-Host "Cloning $url (branch=$branch) -> $dst"
            git clone --single-branch -b $branch $url $dst
          }

          foreach ($d in $deps) { Clone-Repo $d.name $d.url }

          # Copy current repo into cache as well (so we build the PR/commit contents)
          $dstSelf = Join-Path $cache $repo
          New-Item -ItemType Directory -Force -Path $dstSelf | Out-Null

          Write-Host "Copying current repo -> $dstSelf"
          robocopy (Get-Location).Path $dstSelf /MIR /XD .git bin obj .vs packages | Out-Null
          if ($LASTEXITCODE -ge 8) { throw "robocopy failed ($LASTEXITCODE)" }

          # --------------------------------
          # Build in order (deps first)
          # --------------------------------
          $toBuild = @('SAM', $repo)

          foreach ($name in $toBuild) {
            $projDir = Join-Path $cache $name
            if (-not (Test-Path $projDir)) { throw "Missing repo folder: $projDir" }

            $sln = Get-ChildItem -Path $projDir -Filter *.sln -File | Select-Object -First 1
            if (-not $sln) { throw "No .sln found in $projDir" }

            Write-Host "==> Restore: $name\$($sln.Name)"
            msbuild $sln.FullName `
              /t:Restore `
              /m:1 /nr:false /v:m `
              /p:Configuration=Release `
              /p:UseSharedCompilation=false

            Write-Host "==> Rebuild: $name\$($sln.Name)"
            msbuild $sln.FullName `
              /t:Rebuild `
              /m:1 /nr:false /v:m `
              /p:Configuration=Release `
              /p:UseSharedCompilation=false
          }
